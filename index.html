
<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> circle {fill: lightblue; stroke: black;} 
#tooltip {
  opacity: 0;
  position: absolute;
  text-align: left;
  text-wrap: nowrap;
  padding-left: 3px;
  padding-right: 3px;
  width: fit-content;
  height: 100px;
  background: white;
  border: solid;
  border-width: 2px;
  border-color: black;
}
#annotation {
  opacity: 0;
  position: absolute;
  text-align: left;
  padding-left: 3px;
  padding-right: 3px;
  padding-bottom: 3px;
  width: 300px;
  height: auto;
  background: white;
  border: solid;
  border-width: 2px;
  border-color: black;
}
#guide {
  opacity: 0;
  position: absolute;
  border: solid;
  border-width: 2px;
  border-color: red;
}
button {
  border-radius: 4px;
  border-color: gray;
  margin-bottom: 3px; 
  background-color: white;
}
button:hover {
  cursor: pointer;

}
button:disabled,
button[disabled]{
  opacity: 0.6;
  cursor: not-allowed;

}
#Top2000{
  margin-right: 170px; 
}
#Stream{
  margin-right: 50px; 
}
</style>

<head>
  <h1>Top Songs on Spotify and Youtube</h1>
</head>
<body onload = "init()">
<button id = "Full" onclick='changeData(-1)'>Full Dataset</button>
<button id = "Top2000" onclick='changeData(2000)'>Top 2000</button>
<button id = "Replay" onclick='updateStory(1)'>Replay Demo</button>
<div>
</div>
<button id = "Views" onclick='changeData(0,"Views")'>Youtube Views</button>
<button id = "Stream" onclick='changeData(0,"Stream")'>Spotify Streams</button>
<div>
</div>
<button id = "Tempo" onclick='plot("Tempo")'>Tempo</button>
<button id = "Duration" onclick='plot("Duration")'>Duration</button>
<button id = "Intensity" onclick='plot("Intensity")'>Intensity</button>
<button id = "Valence" onclick='plot("Valence")'>Valence</button>
<button id = "Acousticness" onclick='plot("Acousticness")'>Acousticness</button>
<button id = "Loudness" onclick='plot("Loudness")'>Loudness</button>

<div>
</div>
<svg width=700 height=800>
</svg>
<div id = "tooltip"></div>
<div id = "annotation"></div>
<div id = "guide"></div>
<script>

async function init(){
  dataFull = await d3.csv("https://chendeni.github.io/Narrative-Visualization/spotify_youtube_dataset.csv");
  dataTopViews2000 = await d3.csv("https://chendeni.github.io/Narrative-Visualization/spotify_youtube_dataset_most_viewed.csv");
  dataTopStream2000 = await d3.csv("https://chendeni.github.io/Narrative-Visualization/spotify_youtube_dataset_most_streamed.csv");

  width = 600;
  margin = 50;
  maxPageNum = 8;
  currentPlot = "Tempo";
  currentMetric = "Views";
  currentDataSize = 2000;
  currentPageNum = 1;
  changeData(currentDataSize, currentMetric);
  updateStory(1);
} 

async function updateStory(pageNum){
  d3.select("#guide").style("opacity", 0).style("left", (0)+"px").style("top", (0)+"px").style("width",(0)+"px").style("height",(0)+"px");

  if(pageNum>0)
  {
      d3.selectAll("button").attr("disabled",true)
      d3.select("#Replay").style("opacity",0);
  }
  else
  {
      d3.selectAll("button").attr("disabled",null)
      d3.select("#Replay").style("opacity",1);
  }
  currentPageNum = pageNum;
  switch(pageNum)
  {
    case 1:
      displayAnnotation("first", 200, 150, "What makes a song successful? What aspects of a song contributes to its popularity the most?");
      break
    case 2:
      displayAnnotation("default", 460, 70, "This scatter plot shows the number of times a song is listened to on Youtube and its tempo.<br/>There is not much correlation between a song's tempo and its view count.");
      changeData(2000, "Views");
      plot("Tempo");
      break;
    case 3:
      displayAnnotation("default", 460, 70, "Let's try another one.  How does a song's timbre affect its popularity? Songs with mostly synthesized instruments, mostly acoustic instruments, or a mix of both?");
      changeData(2000, "Views");
      plot("Acousticness");
      break;
    case 4:
      displayAnnotation("default", 460, 70, "It seems that most of the top songs use synthesized instruments. What about the songs with less than 2.3M views?");
      d3.select("#guide").style("opacity", 1).style("fill-opacity",0).style("left", (50)+"px").style("top", (475)+"px").style("width",(100)+"px").style("height",(300)+"px");

      changeData(2000, "Views");
      plot("Acousticness");
      break;
    case 5:
      displayAnnotation("default", 460, 70, "This is the full dataset with almost 20000 songs. Most of the less popular songs are either mostly synthesized or mostly acoustic. There are not as many that have an even mix of both.");
      d3.select("#guide").style("opacity", 1).style("fill-opacity",0).style("left", (200)+"px").style("top", (550)+"px").style("width",(300)+"px").style("height",(200)+"px");
      changeData(-1, "Views");
      plot("Acousticness");
      break;
    case 6:
      displayAnnotation("default", 460, 70, "What is the best length for a song? There are a lot more songs at around 3:30 minutes in length. There are not many songs that are too long or too short.");
      d3.select("#guide").style("opacity", 1).style("fill-opacity",0).style("left", (300)+"px").style("top", (160)+"px").style("width",(0)+"px").style("height",(600)+"px");
      changeData(2000, "Views");
      plot("Duration");
      break;
    case 7:
      displayAnnotation("default", 460, 70, "What are the most streamed songs on Spotify? If you want to know the name of a song, move the cursor over the points for more details.");
      d3.select("#guide").style("opacity", 1).style("fill-opacity",0).style("left", (250)+"px").style("top", (140)+"px").style("width",(100)+"px").style("height",(50)+"px");

      changeData(2000, "Stream");
      break;
    case 8:
      displayAnnotation("last", 200, 150, "You have made it to the end of the demo. Click on the buttons above to start exploring.");
      d3.select("#guide").style("opacity", 1).style("fill-opacity",0).style("left", (0)+"px").style("top", (55)+"px").style("width",(450)+"px").style("height",(60)+"px");
      break;
    default:
      displayAnnotation("hide");


  }
  
}

async function displayAnnotation(state, position_x = 0, position_y = 0, text = ""){
  var annotation = d3.select("#annotation");
  annotation.selectAll("button").remove();

  if(state == "hide")
  {
    annotation.style("opacity", 0).style("left", (0)+"px").style("top", (0)+"px").attr("width",(0)+"px");
    annotation.html("");
  }
  else
  {
    annotation.style("opacity", 1).style("left", (position_x)+"px").style("top", (position_y)+"px");
    annotation.html(text+"<br/>");
    if(state != "first")
    {
      annotation.append("button").html("Previous").attr("onclick", 'updateStory(+currentPageNum-1)');
    }
    else
    {
      annotation.append("button").html("Previous").attr("disabled", true);
    }
    annotation.append("label").style("display", "inline-block").style("vertical-align", "middle").style("margin", "0 60px").html("Page "+currentPageNum+"/"+maxPageNum);
    if(state != "last")
    {
      annotation.append("button").style("float", "right").html("Next").attr("onclick", 'updateStory(+currentPageNum+1)');
    }
    else
    {
      annotation.append("button").style("float", "right").html("Finish").attr("onclick", 'updateStory(0)');
    }
  }
}

async function changeData(dataSize = 0, popularityMetric = ""){
  if(popularityMetric == "Views" || popularityMetric == "Stream" || popularityMetric == "Comments")
  {
    currentMetric = popularityMetric;
  }
  if(dataSize == -1 || dataSize == 2000 || dataSize == 500)
  {
    currentDataSize = dataSize;
  }


  if(currentDataSize == -1)
  {
    data = dataFull;
    if(currentMetric == "Views")
    {
          y_label = "View Count";
          y_ticks = [100,1000,10000,100000, 1000000,10000000,100000000,1000000000,8100000000];
          //y = d3.scaleLog().domain([y_ticks[0],y_ticks[y_ticks.length - 1]]).range([width,0]);
    }
    else if(currentMetric == "Stream")
    {
          y_label = "Stream Count";
          y_ticks = [100,1000,10000,100000, 1000000,10000000,100000000,1000000000,3400000000];
          //y = d3.scaleLog().domain([y_ticks[0],y_ticks[y_ticks.length - 1]]).range([width,0]);
    }
  }
  else if(currentDataSize == 2000)
  {
    if(currentMetric == "Views")
    {
          y_label = "View Count";
          data = dataTopViews2000;
          y_ticks = [230000000, 500000000,1000000000,2000000000,4000000000,8100000000];
    }
    else if(currentMetric == "Stream")
    {
          y_label = "Stream Count";
          data = dataTopStream2000;
          y_ticks = [340000000, 500000000,1000000000,2000000000,3400000000];

    }
    
  }
  y = d3.scaleLog().domain([y_ticks[0],y_ticks[y_ticks.length - 1]]).range([width,0]);
  plot(currentPlot);


}

  
async function plot(plotName){
  currentPlot = plotName;
  switch(plotName)
  {
    case "Tempo":
      displayScatterplot("Tempo", [50,200], [50,100,150,200], "Tempo (BPM)",".0f", "linear");
      break;
    case "Duration":
      if(currentDataSize == -1)
      {
        displayScatterplot("Duration_ms", [40000,700000], [40000,100000,200000,400000,700000],"Duration (ms)", "~s", "log");
      }
      else
      {
        displayScatterplot("Duration_ms", [100000,700000], [100000,200000,400000,700000],"Duration (ms)", "~s", "log");
      }
      break;
    case "Intensity":
      displayScatterplot("Energy", [0,1], [0,0.2,0.4,0.6,0.8,1], "Intensity", ".2f", "linear");
      break;
    case "Valence":
      displayScatterplot("Valence", [0,1], [0,0.2,0.4,0.6,0.8,1], "Valence", ".2f", "linear")
      break;
    case "Acousticness":
      displayScatterplot("Acousticness", [0,1], [0,0.2,0.4,0.6,0.8,1], "Acousticness", ".2f", "linear");
      break;
    case "Loudness":
      if(currentDataSize == -1)
      {
        displayScatterplot("Loudness", [-40,1], [-40,-30,-20,-10,0], "Loudness (dBFS)", ".2f", "linear");
      }
      else
      {
        displayScatterplot("Loudness", [-20,1], [-20,-15,-10,-5,0], "Loudness (dBFS)", ".2f", "linear");
      }
      break;
    default:
      displayScatterplot("Tempo", [50,200], [50,100,150,200], "Tempo (BPM)", ".2f", "log");
  }
  updateButtons();
}
  
async function updateButtons(){
  d3.selectAll("button").style("background-color", "white");
  d3.select("#"+currentPlot).style("background-color", "lightblue");
  d3.select("#"+currentMetric).style("background-color", "lightblue");
  if(currentDataSize == -1)
  {
    d3.select("#Full").style("background-color", "lightblue");
  }
  else if(currentDataSize == 2000)
  {
    d3.select("#Top2000").style("background-color", "lightblue");
  }

}
  
async function displayScatterplot(valueName, x_domain, x_ticks, x_label, x_format, scaleType) {
d3.select("svg").selectAll("g").remove();
d3.select("svg").selectAll("text").remove();

  //var maxValue = d3.max(data, function(d) { return +d[valueName]; } );
  var tooltip = d3.select("#tooltip");
  
var x;
if(scaleType == "log")
{
  x = d3.scaleLog().domain(x_domain).range([0,width]);
}
else
{
  x = d3.scaleLinear().domain(x_domain).range([0,width]);
}
//svg_coords = d3.select("svg").getBoundingClientRect();
d3.select("svg").append("g").attr("transform","translate("+margin+","+margin+")").selectAll("circle").data(data).enter().append("circle")
.attr("cx",function(d,i){return x(d[valueName]);})
.attr("cy",function(d,i){return y(d[currentMetric]);})
.attr("r",function(d,i){return 2;})
.on("mouseover", function(d,i){tooltip.style("opacity", 1).style("height", (100)+"px").style("left", (x(d[valueName])+70)+"px").style("top", (y(d[currentMetric])+210)+"px").html("Artist: "+d["Artist"]+"</br>Track: "+d["Track"]+"</br>"+y_label+": "+d[currentMetric]+"</br>"+x_label+": "+d[valueName]); d3.select(this).style("stroke", "orange").style("fill", "orange"); })
.on("mouseout", function(d,i){tooltip.style("opacity", 0).style("height", (0)+"px").html(""); d3.select(this).style("stroke", "black").style("fill", "lightblue");});
d3.select("svg").append("g").attr("transform","translate("+margin+","+margin+")").call(d3.axisLeft(y).tickValues(y_ticks).tickFormat(d3.format("~s")));

d3.select("svg").append("g").attr("transform","translate("+margin+","+(margin+width)+")").call(d3.axisBottom(x).tickValues(x_ticks).tickFormat(d3.format(x_format)));

d3.select("svg").append("text").attr("transform","translate("+(margin+(width/2))+","+((1.75*margin)+width)+")").style("text-anchor", "middle").text(x_label);
d3.select("svg").append("text").attr("transform","translate("+(0.25*margin)+","+(margin+(0.5*width))+") rotate(-90)").style("text-anchor", "middle").text(y_label);

  //d3.select("body").selectAll("p").data(data).enter().append("p").html(function(d,i){return d.Artist + maxViews;}) 
}





  
/*
async function initTempo() {
d3.select("svg").selectAll("g").remove();

//var maxViews = d3.max(data, function(d) { return +d.Views; } );
var maxTempo = d3.max(data, function(d) { return +d.Tempo; } );
//var y = d3.scaleLog().domain([230000000,maxViews]).range([width,0]);
var x = d3.scaleLog().domain([50,maxTempo]).range([0,width]);

d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").selectAll("circle").data(data).enter().append("circle")
.attr("cx",function(d,i){return x(d.Tempo);})
.attr("cy",function(d,i){return y(d.Views);})
.attr("r",function(d,i){return 2;})
d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").call(d3.axisLeft(y).tickValues([230000000, 500000000,1000000000,2000000000,4000000000,8100000000]).tickFormat(d3.format("~s")));

d3.select("svg").append("g").attr("transform","translate("+50+","+(50+width)+")").call(d3.axisBottom(x).tickValues([50,100,150,200]).tickFormat(d3.format("~s")));

  
//d3.select("body").selectAll("p").data(data).enter().append("p").html(function(d,i){return d.Artist + maxViews;})

  
}
  
  
async function initDuration() {
d3.select("svg").selectAll("g").remove();
var maxDuration = d3.max(data, function(d) { return +d.Duration_ms; } );
var x = d3.scaleLog().domain([100000,maxDuration]).range([0,width]);

d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").selectAll("circle").data(data).enter().append("circle")
.attr("cx",function(d,i){return x(d.Duration_ms);})
.attr("cy",function(d,i){return y(d.Views);})
.attr("r",function(d,i){return 2;})
d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").call(d3.axisLeft(y).tickValues([230000000, 500000000,1000000000,2000000000,4000000000,8100000000]).tickFormat(d3.format("~s")));

d3.select("svg").append("g").attr("transform","translate("+50+","+(50+width)+")").call(d3.axisBottom(x).tickValues([100000,200000,400000,700000]).tickFormat(d3.format("~s")));

}


  
async function initEnergy() {
d3.select("svg").selectAll("g").remove();
//var maxEnergy = d3.max(data, function(d) { return +d.Energy; } );
var x = d3.scaleLinear().domain([0,1]).range([0,width]);

d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").selectAll("circle").data(data).enter().append("circle")
.attr("cx",function(d,i){return x(d.Energy);})
.attr("cy",function(d,i){return y(d.Views);})
.attr("r",function(d,i){return 2;})
d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").call(d3.axisLeft(y).tickValues([230000000, 500000000,1000000000,2000000000,4000000000,8100000000]).tickFormat(d3.format("~s")));

d3.select("svg").append("g").attr("transform","translate("+50+","+(50+width)+")").call(d3.axisBottom(x).tickValues([0,0.2,0.4,0.6,0.8,1]).tickFormat(d3.format("~s")));

}
async function initValence() {
d3.select("svg").selectAll("g").remove();
var x = d3.scaleLinear().domain([0,1]).range([0,width]);

d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").selectAll("circle").data(data).enter().append("circle")
.attr("cx",function(d,i){return x(d.Valence);})
.attr("cy",function(d,i){return y(d.Views);})
.attr("r",function(d,i){return 2;})
d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").call(d3.axisLeft(y).tickValues([230000000, 500000000,1000000000,2000000000,4000000000,8100000000]).tickFormat(d3.format("~s")));

d3.select("svg").append("g").attr("transform","translate("+50+","+(50+width)+")").call(d3.axisBottom(x).tickValues([0,0.2,0.4,0.6,0.8,1]).tickFormat(d3.format("~s")));

}
  
async function initAcousticness() {
d3.select("svg").selectAll("g").remove();
var x = d3.scaleLinear().domain([0,1]).range([0,width]);

d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").selectAll("circle").data(data).enter().append("circle")
.attr("cx",function(d,i){return x(d.Acousticness);})
.attr("cy",function(d,i){return y(d.Views);})
.attr("r",function(d,i){return 2;})
d3.select("svg").append("g").attr("transform","translate("+50+","+50+")").call(d3.axisLeft(y).tickValues([230000000, 500000000,1000000000,2000000000,4000000000,8100000000]).tickFormat(d3.format("~s")));

d3.select("svg").append("g").attr("transform","translate("+50+","+(50+width)+")").call(d3.axisBottom(x).tickValues([0,0.2,0.4,0.6,0.8,1]).tickFormat(d3.format("~s")));

}
*/
  
</script>
</body>
</html>
